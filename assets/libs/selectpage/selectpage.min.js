!function(factory){"function"==typeof define&&define.amd?define(["jquery"],factory):factory(jQuery)}(function($){"use strict";function SelectPage(combo_input,option){var option=$.extend({},option,$(combo_input).data());option=this._setCamelcaseToUnderscore(option),this._setOption(option),this._setLanguage(),this._setCssClass(),this._setProp(),this._setElem(combo_input,option),this._setButtonAttrDefault(),this._setInitRecord(),this._ehButton(),this._ehComboInput(),this._ehWhole(),$(this.elem.container).data(constants.dataKey,this)}var constants={dataKey:"selectPageObject",objStatusKey:"selectPage-self-mark",objStatusIndex:"selectPage-self-index"};return $.fn.selectPage=function(option){var arr=[];return this.each(function(){arr.push(new SelectPage(this,option))}),void 0!==option&&void 0!==option.instance&&option.instance?$(arr):this},$.extend(SelectPage.prototype,{_setOption:function(option){option=this._setOption1st(option),option=this._setOption2nd(option),this.option=option},_setOption1st:function(option){return option=$.extend({lang:"cn",multiple:!1,init_record:!1,db_table:"tbl",field:"name",and_or:"AND",per_page:10,primary_key:"id",button_img:"dist/btn.png",bind_to:!1,focus_drop_list:!0,auto_select_first:!1,auto_fill_result:!1,no_result_clean:!1,format_item:!1,format_fill:!1,select_only:!0},option),$.each({data:"source",key_field:"primary_key",show_field:"field",init_code:"init_record",page_size:"per_page"},function(i,j){void 0!==option[i]&&(option[j]=option[i],delete option[i])}),option},_setOption2nd:function(option){option.search_field=void 0===option.search_field?option.field:option.search_field,option.and_or=option.and_or.toUpperCase();for(var arr=["hide_field","show_field","search_field"],i=0;i<arr.length;i++)option[arr[i]]=this._strToArray(option[arr[i]]);return option.order_by=void 0===option.order_by?option.search_field:option.order_by,option.order_by=this._setOrderbyOption(option.order_by,option.field),option},_setCamelcaseToUnderscore:function(option){return $.each(option,function(i,j){var field=i.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase();field!==i&&(option[field]=j,delete option[i])}),option},_strToArray:function(str){return str?str.replace(/[\s　]+/g,"").split(","):""},_setOrderbyOption:function(arg_order,arg_field){var arr=[],orders=[];if("object"==typeof arg_order)for(var i=0;i<arg_order.length;i++)orders=$.trim(arg_order[i]).split(" "),arr[i]=2==orders.length?orders:[orders[0],"ASC"];else orders=$.trim(arg_order).split(" "),arr[0]=2==orders.length?orders:orders[0].match(/^(ASC|DESC)$/i)?[arg_field,orders[0]]:[orders[0],"ASC"];return arr},_setLanguage:function(){var message;switch(this.option.lang){case"de":message={add_btn:"Hinzufügen-Button",add_title:"Box hinzufügen",del_btn:"Löschen-Button",del_title:"Box löschen",next:"Nächsten",next_title:"Nächsten"+this.option.per_page+" (Pfeil-rechts)",prev:"Vorherigen",prev_title:"Vorherigen"+this.option.per_page+" (Pfeil-links)",first_title:"Ersten (Umschalt + Pfeil-links)",last_title:"Letzten (Umschalt + Pfeil-rechts)",get_all_btn:"alle (Pfeil-runter)",get_all_alt:"(Button)",close_btn:"Schließen (Tab)",close_alt:"(Button)",loading:"lade...",loading_alt:"(lade)",page_info:"num_page_top - num_page_end von cnt_whole",select_ng:"Achtung: Bitte wählen Sie aus der Liste aus.",select_ok:"OK : Richtig ausgewählt.",not_found:"nicht gefunden",ajax_error:"Bei der Verbindung zum Server ist ein Fehler aufgetreten. (ajax-combobox)"};break;case"en":message={add_btn:"Add button",add_title:"add a box",del_btn:"Del button",del_title:"delete a box",next:"Next",next_title:"Next"+this.option.per_page+" (Right key)",prev:"Prev",prev_title:"Prev"+this.option.per_page+" (Left key)",first_title:"First (Shift + Left key)",last_title:"Last (Shift + Right key)",get_all_btn:"Get All (Down key)",get_all_alt:"(button)",close_btn:"Close (Tab key)",close_alt:"(button)",loading:"loading...",loading_alt:"(loading)",page_info:"num_page_top - num_page_end of cnt_whole",select_ng:"Attention : Please choose from among the list.",select_ok:"OK : Correctly selected.",not_found:"not found",ajax_error:"An error occurred while connecting to server. (ajax-combobox)"};break;case"cn":message={add_btn:"添加按钮",add_title:"添加区域",del_btn:"删除按钮",del_title:"删除区域",next:"下一页",next_title:"下"+this.option.per_page+" (→)",prev:"上一页",prev_title:"上"+this.option.per_page+" (←)",first_title:"首页 (Shift + ←)",last_title:"尾页 (Shift + →)",get_all_btn:"获得全部 (↓)",get_all_alt:"(按钮)",close_btn:"关闭 (Tab键)",close_alt:"(按钮)",loading:"读取中...",loading_alt:"(读取中)",page_info:"num_page_top - num_page_end (共 cnt_whole)",select_ng:"请注意：请从列表中选择.",select_ok:"OK : 已经选择.",not_found:"无查询结果",ajax_error:"连接到服务器时发生错误！"};break;case"es":message={add_btn:"Agregar boton",add_title:"Agregar una opcion",del_btn:"Borrar boton",del_title:"Borrar una opcion",next:"Siguiente",next_title:"Proximas "+this.option.per_page+" (tecla derecha)",prev:"Anterior",prev_title:"Anteriores "+this.option.per_page+" (tecla izquierda)",first_title:"Primera (Shift + Left)",last_title:"Ultima (Shift + Right)",get_all_btn:"Ver todos (tecla abajo)",get_all_alt:"(boton)",close_btn:"Cerrar (tecla TAB)",close_alt:"(boton)",loading:"Cargando...",loading_alt:"(Cargando)",page_info:"num_page_top - num_page_end de cnt_whole",select_ng:"Atencion: Elija una opcion de la lista.",select_ok:"OK: Correctamente seleccionado.",not_found:"no encuentre",ajax_error:"Un error ocurrió mientras conectando al servidor. (ajax-combobox)"};break;case"pt-br":message={add_btn:"Adicionar botão",add_title:"Adicionar uma caixa",del_btn:"Apagar botão",del_title:"Apagar uma caixa",next:"Próxima",next_title:"Próxima "+this.option.per_page+" (tecla direita)",prev:"Anterior",prev_title:"Anterior "+this.option.per_page+" (tecla esquerda)",first_title:"Primeira (Shift + Left)",last_title:"Última (Shift + Right)",get_all_btn:"Ver todos (Seta para baixo)",get_all_alt:"(botão)",close_btn:"Fechar (tecla TAB)",close_alt:"(botão)",loading:"Carregando...",loading_alt:"(Carregando)",page_info:"num_page_top - num_page_end de cnt_whole",select_ng:"Atenção: Escolha uma opção da lista.",select_ok:"OK: Selecionado Corretamente.",not_found:"não encontrado",ajax_error:"Um erro aconteceu enquanto conectando a servidor. (ajax-combobox)"};break;case"ja":message={add_btn:"追加ボタン",add_title:"入力ボックスを追加します",del_btn:"削除ボタン",del_title:"入力ボックスを削除します",next:"次へ",next_title:"次の"+this.option.per_page+"件 (右キー)",prev:"前へ",prev_title:"前の"+this.option.per_page+"件 (左キー)",first_title:"最初のページへ (Shift + 左キー)",last_title:"最後のページへ (Shift + 右キー)",get_all_btn:"全件取得 (下キー)",get_all_alt:"画像:ボタン",close_btn:"閉じる (Tabキー)",close_alt:"画像:ボタン",loading:"読み込み中...",loading_alt:"画像:読み込み中...",page_info:"num_page_top - num_page_end 件 (全 cnt_whole 件)",select_ng:"注意 : リストの中から選択してください",select_ok:"OK : 正しく選択されました。",not_found:"(0 件)",ajax_error:"サーバとの通信でエラーが発生しました。(ajax-combobox)"}}this.message=message},_setCssClass:function(){var css_class={container:"sp_container",container_open:"sp_container_open",selected:"sp_selected",re_area:"sp_result_area",element_box:"sp_element_box",navi:"pagination",results:"sp_results",re_off:"sp_results_off",select:"sp_over",select_ok:"sp_select_ok",select_ng:"sp_select_ng",input_off:"sp_input_off",button:"sp_button",btn_on:"sp_btn_on",btn_out:"sp_btn_out",input:"sp_input"};this.css_class=css_class},_setProp:function(){this.prop={is_suggest:!1,page_all:1,page_suggest:1,max_all:1,max_suggest:1,is_paging:!1,is_loading:!1,xhr:!1,key_paging:!1,key_select:!1,prev_value:""},this.template={tag:{content:'<li class="selected_tag" itemvalue="#item_value#">#item_text#<span class="tag_close">&times;</span></li>',textKey:"#item_text#",valueKey:"#item_value#"}}},_setElem:function(combo_input,option){var value=$(combo_input).val();value&&!option.init_record&&(this.option.init_record=$.isArray(value)?value.join(","):value);var elem={};$(combo_input).outerWidth();elem.combo_input=$(combo_input).attr({autocomplete:"off"}).addClass(this.css_class.input).wrap("<div>"),elem.container=$(elem.combo_input).parent().addClass(this.css_class.container),elem.button=$("<div>").addClass(this.css_class.button),elem.img=$('<span class="bs-caret"><span class="caret"></span></span>'),elem.element_box=$("<ul>").addClass(this.css_class.element_box),elem.result_area=$("<div>").addClass(this.css_class.re_area),elem.navi=$("<ul>").addClass(this.css_class.navi).addClass("hide"),elem.results=$("<ul>").addClass(this.css_class.results);var input_id=void 0!==$(elem.combo_input).attr("id")?$(elem.combo_input).attr("id"):$(elem.combo_input).attr("name"),input_name=void 0!==$(elem.combo_input).attr("name")?$(elem.combo_input).attr("name"):"selectPage",hidden_name=input_name,hidden_id=input_id;if(input_name.match(/\]$/)?input_name=input_name.replace(/\]?$/,"_text"):input_name+="_text",input_id.match(/\]$/)?input_id=input_id.replace(/\]?$/,"_text"):input_id+="_text",$(elem.combo_input).is("select")){elem.hidden=$('<select class="hide" />').attr({name:hidden_name,id:hidden_id}).prop("multiple",$(elem.combo_input).prop("multiple")).empty();var newinput=$('<input type="text" class="form-control" />').attr({name:input_name,id:input_id}).addClass(this.css_class.input);if(!option.source){var source=[];$("option",elem.combo_input).each(function(i,j){source.push({id:i,name:$(this).text()})}),this.option.source=source}$(elem.combo_input).replaceWith(newinput),elem.combo_input=newinput}else elem.hidden=$('<input type="hidden" class="hide" />').attr({name:hidden_name,id:hidden_id}).val(""),$(elem.combo_input).attr({name:input_name,id:input_id});if($(elem.hidden).addClass("selectpage-input-hidden"),$(elem.container).append(elem.button).append(elem.result_area).append(elem.hidden),$(elem.button).append(elem.img),$(elem.result_area).append(elem.results).append(elem.navi),option.multiple){$(elem.container).addClass("sp_container_combo"),$(elem.combo_input).addClass("sp_combo_input").before($(elem.element_box));var li=$("<li>").addClass("input_box");$(li).append($(elem.combo_input)),$(elem.element_box).append($(li)),$(elem.combo_input).attr("placeholder")&&$(elem.combo_input).attr("placeholder_bak",$(elem.combo_input).attr("placeholder"))}$(elem.container).parent().hasClass("input-group")&&$(elem.container).height($(elem.container).parent().height()),this.elem=elem},_setButtonAttrDefault:function(){this.option.select_only&&(""!==$(this.elem.combo_input).val()?$(this.elem.hidden).val()?$(this.elem.combo_input).prop("title",this.message.select_ok).removeClass(this.css_class.select_ng).addClass(this.css_class.select_ok):$(this.elem.combo_input).prop("title",this.message.select_ng).removeClass(this.css_class.select_ok).addClass(this.css_class.select_ng):$(this.elem.combo_input).prop("title","").removeClass(this.css_class.select_ng)),$(this.elem.button).prop("title",this.message.get_all_btn)},_setInitRecord:function(){var self=this;if(!1!==this.option.init_record)if(self._setHiddenValue(self.option.init_record),"object"==typeof self.option.source){var data=new Array,keyarr=self.option.init_record.split(",");$.each(keyarr,function(index,row){for(var i=0;i<self.option.source.length;i++)if(self.option.source[i][self.option.primary_key]==row){data.push(self.option.source[i]);break}}),!self.option.multiple&&data.length>1&&(data=null),self._afterInit(self,data)}else{var _paramsFunc=self.option.params,_params={},_orgParams={db_table:self.option.db_table,field:self.option.field,order_by:self.option.order_by,pkey_name:self.option.primary_key,pkey_value:self.option.init_record};if(_paramsFunc){var result=$.isFunction(_paramsFunc)?_paramsFunc():_paramsFunc;_params=result&&$.isPlainObject(result)?$.extend({},_orgParams,result):_orgParams}else _params=_orgParams;$.ajax({dataType:"json",url:self.option.source,data:_params,success:function(json){void 0!==json.list&&$.isArray(json.list)&&self._afterInit(self,json.list)},error:function(jqXHR,textStatus,errorThrown){self._ajaxErrorNotify(self,errorThrown)}})}},_afterInit:function(self,data){if(data)if($.isArray(data)||(data=[data]),self.option.multiple)$(self.elem.combo_input).val(""),$.each(data,function(i,row){var item={text:row[self.option.field],value:row[self.option.primary_key]};self._isAlreadySelected(self,item)||self._addNewTag(self,item)}),self._tagValuesSet(self),self._inputResize(self);else{var row=data[0];$(self.elem.combo_input).val(row[self.option.field]),self._setHiddenValue(row[self.option.primary_key]),self.prop.prev_value=row[self.option.field],self.option.select_only&&$(self.elem.combo_input).attr("title",self.message.select_ok).removeClass(self.css_class.select_ng).addClass(self.css_class.select_ok)}},_ehButton:function(){var self=this;$(self.elem.button).mouseup(function(ev){$(self.elem.result_area).is(":hidden")&&!$(self.elem.combo_input).prop("disabled")?$(self.elem.combo_input).focus():self._hideResults(self),ev.stopPropagation()}).mouseover(function(){$(self.elem.button).addClass(self.css_class.btn_on).removeClass(self.css_class.btn_out)}).mouseout(function(){$(self.elem.button).addClass(self.css_class.btn_out).removeClass(self.css_class.btn_on)}).mouseout()},_ehComboInput:function(){var self=this;$(self.elem.combo_input).keyup(function(ev){self._processKey(self,ev)}).keydown(function(e){8===e.keyCode&&self.option.multiple&&""==$(self.elem.combo_input).val()&&$(self.elem.combo_input).parent().prev().find(".tag_close").trigger("click")}).focus(function(e){$(self.elem.result_area).is(":hidden")&&(e.stopPropagation(),self.elem.navi.addClass("hide"),self.prop.first_show=!0,self.prop.page_move=!1,self.prop.is_suggest=!1,self._suggest(self))}).click(function(){self._setCssFocusedInput(self)}).blur(function(){$(self.elem.hidden).trigger("blur")}),self.option.multiple&&($(self.elem.element_box).click(function(e){var srcEl=e.target||e.srcElement;$(srcEl).is("ul")&&$(self.elem.combo_input).focus()}),$(self.elem.element_box).on("click","span.tag_close",function(){var li=$(this).closest("li"),key=$(li).attr("itemvalue"),keys=$(self.elem.hidden).val();if("undefined"!=$.type(key)&&keys){var keyarr=$.isArray(keys)?keys:keys?keys.split(","):new Array,index=$.inArray(key.toString(),keyarr);-1!=index&&(keyarr.splice(index,1),self._setHiddenValue(keyarr.toString()))}$(li).remove(),self._inputResize(self),$("li[pkey='"+key+"']",self.elem.results).removeClass(self.css_class.selected)}),self._inputResize(self))},_setHiddenValue:function(value){var self=this;$(self.elem.hidden).is("select")?($(self.elem.hidden).empty(),value=$.isArray(value)?value:$(self.elem.hidden).prop("multiple")?(value+"").split(","):value,$.each(value,function(i,j){$(self.elem.hidden).append($("<option />").prop("selected",!0).val(j).text(j))})):(value=$.isArray(value)?value.join(","):value,$(self.elem.hidden).val(value))},_ehWhole:function(){$(this.elem.container).mousedown(function(){var thisindex=$("div.sp_container").index(this),lastindex=$(document.body).data(constants.objStatusIndex);void 0!=lastindex&&thisindex!=lastindex?$(document.body).data(constants.objStatusKey,!1):$(document.body).data(constants.objStatusKey,!0),$(document.body).data(constants.objStatusIndex,thisindex)}),$(document).off("mousedown.selectPage").on("mousedown.selectPage",function(e){if($(document.body).data(constants.objStatusKey))$(document.body).data(constants.objStatusKey,!1);else{var cleanContent=function(obj){$(obj.elem.combo_input).val(""),obj.option.multiple||$(obj.elem.hidden).val("")};$("div.sp_container").each(function(){var d=$(this).data(constants.dataKey);if($(this).hasClass(d.css_class.container_open)){if(!$(d.elem.combo_input).val()&&$(d.elem.hidden).val()&&!d.option.multiple)return d.prop.page_all=1,cleanContent(d),d._hideResults(d),!0;$("li",$(d.elem.results)).size()>0?d.option.auto_fill_result?$("li.sp_selected",$(d.elem.results)).size()>0?d._hideResults(d):$("li.sp_over",$(d.elem.results)).size()>0?$(d.elem.hidden).val()?d._hideResults(d):d._selectCurrentLine(d,!0):d.option.auto_select_first?$(d.elem.hidden).val()?d._hideResults(d):(d._nextLine(d),d._selectCurrentLine(d,!0)):d._hideResults(d):d._hideResults(d):(d.option.no_result_clean?cleanContent(d):d.option.multiple||$(d.elem.hidden).val(""),d._hideResults(d))}})}})},_ehResults:function(){var self=this;$(self.elem.results).children("li").mouseover(function(){self.prop.key_select?self.prop.key_select=!1:($(self.elem.results).children("li").removeClass(self.css_class.select),$(this).addClass(self.css_class.select),self._setCssFocusedResults(self))}).click(function(e){self.prop.key_select?self.prop.key_select=!1:(e.preventDefault(),e.stopPropagation(),self._selectCurrentLine(self,!1))})},_ehNaviPaging:function(self){$("li.csFirstPage",$(self.elem.navi)).off("click").on("click",function(ev){$(self.elem.combo_input).focus(),ev.preventDefault(),self._firstPage(self)}),$("li.csPreviousPage",$(self.elem.navi)).off("click").on("click",function(ev){$(self.elem.combo_input).focus(),ev.preventDefault(),self._prevPage(self)}),$("li.csNextPage",$(self.elem.navi)).off("click").on("click",function(ev){$(self.elem.combo_input).focus(),ev.preventDefault(),self._nextPage(self)}),$("li.csLastPage",$(self.elem.navi)).off("click").on("click",function(ev){$(self.elem.combo_input).focus(),ev.preventDefault(),self._lastPage(self)})},_ajaxErrorNotify:function(self,errorThrown){console.log(self.message.ajax_error)},_scrollWindow:function(self,enforce){var target_size,current_result=self._getCurrentLine(self),target_top=current_result&&!enforce?current_result.offset().top:$(self.elem.container).offset().top;self.prop.size_li=$(self.elem.results).children("li:first").outerHeight(),target_size=self.prop.size_li;var gap,client_height=$(window).height(),scroll_top=$(window).scrollTop(),scroll_bottom=scroll_top+client_height-target_size;if($(current_result).length)if(target_top<scroll_top||target_size>client_height)gap=target_top-scroll_top;else{if(!(target_top>scroll_bottom))return;gap=target_top-scroll_bottom}else target_top<scroll_top&&(gap=target_top-scroll_top);window.scrollBy(0,gap)},_setCssFocusedInput:function(self){$(self.elem.results).addClass(self.css_class.re_off),$(self.elem.combo_input).removeClass(self.css_class.input_off)},_setCssFocusedResults:function(self){$(self.elem.results).removeClass(self.css_class.re_off),$(self.elem.combo_input).addClass(self.css_class.input_off)},_checkValue:function(self){var now_value=$(self.elem.combo_input).val();now_value!=self.prop.prev_value&&(self.prop.prev_value=now_value,self.prop.first_show=!1,self.option.select_only&&self._setButtonAttrDefault(),self.prop.page_suggest=1,self.prop.is_suggest=!0,self._suggest(self))},_processKey:function(self,e){if($.inArray(e.keyCode,[27,38,40,9])>-1&&$(self.elem.result_area).is(":visible")||$.inArray(e.keyCode,[37,39,13,9])>-1&&self._getCurrentLine(self)||40==e.keyCode)switch(e.preventDefault(),e.stopPropagation(),e.cancelBubble=!0,e.returnValue=!1,e.keyCode){case 37:e.shiftKey?self._firstPage(self):self._prevPage(self);break;case 38:self.prop.key_select=!0,self._prevLine(self);break;case 39:e.shiftKey?self._lastPage(self):self._nextPage(self);break;case 40:$(self.elem.results).children("li").length?(self.prop.key_select=!0,self._nextLine(self)):(self.prop.is_suggest=!1,self._suggest(self));break;case 9:self.prop.key_paging=!0,self._selectCurrentLine(self,!0);break;case 13:self._selectCurrentLine(self,!0);break;case 27:self.prop.key_paging=!0,self._hideResults(self)}else 16!=e.keyCode&&self._setCssFocusedInput(self),self._inputResize(self),self._checkValue(self)},_abortAjax:function(self){self.prop.xhr&&(self.prop.xhr.abort(),self.prop.xhr=!1)},_suggest:function(self){var q_word;if(q_word=self.prop.first_show?"":$.trim($(self.elem.combo_input).val()),q_word=q_word.split(/[\s　]+/),self._abortAjax(self),self._setLoading(self),self.prop.is_paging){var obj=self._getCurrentLine(self);self.prop.is_paging=obj?$(self.elem.results).children("li").index(obj):-1}else self.prop.is_suggest||(self.prop.is_paging=0);var which_page_num=self.prop.page_all;"object"==typeof self.option.source?self._searchForJson(self,q_word,which_page_num):self._searchForDb(self,q_word,which_page_num)},_setLoading:function(self){$(self.elem.navi_info).text(self.message.loading),""===$(self.elem.results).html()&&($(self.elem.navi).children("p").empty(),self._calcWidthResults(self),$(self.elem.container).addClass(self.css_class.container_open))},_searchForDb:function(self,q_word,which_page_num){var _paramsFunc=self.option.params,_params={},searchKey=self.option.search_field,_orgParams={q_word:q_word,pageNumber:which_page_num,pageSize:self.option.per_page,and_or:self.option.and_or,order_by:self.option.order_by,db_table:self.option.db_table,field:self.option.field,pkey_name:self.option.primary_key,search_field:searchKey};if(_orgParams[searchKey]=q_word[0],_paramsFunc){var result=$.isFunction(_paramsFunc)?_paramsFunc():_paramsFunc;_params=result&&$.isPlainObject(result)?$.extend({},_orgParams,result):_orgParams}else _params=_orgParams;self.prop.xhr=$.ajax({dataType:"json",url:self.option.source,data:_params,success:function(returnData){if(void 0===returnData.list||!$.isArray(returnData.list))return self.prop.xhr=null,void self._notFoundSearch(self);void 0===returnData.total&&(returnData.total=returnData.list.length);var json={};json.originalResult=returnData.list,json.cnt_whole=returnData.total,json.candidate=[],json.primary_key=[],json.cnt_page=json.originalResult.length;for(var i=0;i<json.cnt_page;i++)for(var key in json.originalResult[i])key==self.option.primary_key&&json.primary_key.push(json.originalResult[i][key]),key==self.option.field&&json.candidate.push(json.originalResult[i][key]);self._prepareResults(self,json,q_word,which_page_num)},error:function(jqXHR,textStatus,errorThrown){"abort"!=textStatus&&(self._hideResults(self),self._ajaxErrorNotify(self,errorThrown))},complete:function(){self.prop.xhr=null}})},_searchForJson:function(self,q_word,which_page_num){var matched=[],esc_q=[],sorted=[],json={},i=0,arr_reg=[];do{esc_q[i]=q_word[i].replace(/\W/g,"\\$&").toString(),arr_reg[i]=new RegExp(esc_q[i],"gi"),i++}while(i<q_word.length);for(i=0;i<self.option.source.length;i++){for(var flag=!1,row=self.option.source[i],j=0;j<arr_reg.length;j++){var itemText=row[self.option.field];if(self.option.format_item&&$.isFunction(self.option.format_item)&&(itemText=self.option.format_item(row)),itemText.match(arr_reg[j])){if(flag=!0,"OR"==self.option.and_or)break}else if(flag=!1,"AND"==self.option.and_or)break}flag&&matched.push(row)}if(void 0!==matched.length){json.cnt_whole=matched.length;var reg1=new RegExp("^"+esc_q[0]+"$","gi"),reg2=new RegExp("^"+esc_q[0],"gi"),matched1=[],matched2=[],matched3=[];for(i=0;i<matched.length;i++)matched[i][self.option.order_by[0][0]].match(reg1)?matched1.push(matched[i]):matched[i][self.option.order_by[0][0]].match(reg2)?matched2.push(matched[i]):matched3.push(matched[i]);if(self.option.order_by[0][1].match(/^asc$/i)?(matched1=self._sortAsc(self,matched1),matched2=self._sortAsc(self,matched2),matched3=self._sortAsc(self,matched3)):(matched1=self._sortDesc(self,matched1),matched2=self._sortDesc(self,matched2),matched3=self._sortDesc(self,matched3)),sorted=sorted.concat(matched1).concat(matched2).concat(matched3),self.prop.page_move)sorted.length<=(which_page_num-1)*self.option.per_page&&(which_page_num=1,self.prop.page_all=1);else if(!self.option.multiple){var currentValue=$(self.elem.hidden).val();if(void 0!==currentValue&&""!=$.trim(currentValue)){var index=0;$.each(sorted,function(i,row){if(row[self.option.primary_key]==currentValue)return index=i+1,!1}),(which_page_num=Math.ceil(index/self.option.per_page))<1&&(which_page_num=1),self.prop.page_all=which_page_num}}var start=(which_page_num-1)*self.option.per_page,end=start+self.option.per_page;for(json.originalResult=[],i=start;i<end&&void 0!==sorted[i];i++){json.originalResult.push(sorted[i]);for(var key in sorted[i])key==self.option.primary_key&&(void 0===json.primary_key&&(json.primary_key=[]),json.primary_key.push(sorted[i][key])),key==self.option.field&&(void 0===json.candidate&&(json.candidate=[]),json.candidate.push(sorted[i][key]))}void 0===json.candidate&&(json.candidate=[]),json.cnt_page=json.candidate.length,self._prepareResults(self,json,q_word,which_page_num)}else self._notFoundSearch(self)},_sortAsc:function(self,arr){return arr.sort(function(a,b){return a[self.option.order_by[0][0]].localeCompare(b[self.option.order_by[0][0]])}),arr},_sortDesc:function(self,arr){return arr.sort(function(a,b){return b[self.option.order_by[0][0]].localeCompare(a[self.option.order_by[0][0]])}),arr},_notFoundSearch:function(self){$(self.elem.navi_info).text(self.message.not_found),$(self.elem.navi_p).hide(),$(self.elem.results).empty(),self._calcWidthResults(self),$(self.elem.container).addClass(self.css_class.container_open),self._setCssFocusedInput(self)},_prepareResults:function(self,json,q_word,which_page_num){self._setNavi(self,json.cnt_whole,json.cnt_page,which_page_num),json.primary_key||(json.primary_key=!1),self.option.select_only&&1===json.candidate.length&&json.candidate[0]==q_word[0]&&(self._setHiddenValue(json.primary_key[0]),this._setButtonAttrDefault());var is_query=!1;if(q_word&&q_word.length>0&&q_word[0]&&(is_query=!0),self._displayResults(self,json,is_query),!1===self.prop.is_paging)self._setCssFocusedInput(self);else{if(!self.option.multiple){var liSelected=$("li.sp_selected",$(self.elem.results));if(0==$(liSelected).size()){var idx=self.prop.is_paging,limit=$(self.elem.results).children("li").length-1;idx>limit&&(idx=limit);var obj=$(self.elem.results).children("li").eq(idx);$(obj).addClass(self.css_class.select)}else $(liSelected).addClass(self.css_class.select)}self.prop.is_paging=!1,self._setCssFocusedResults(self)}},_setNavi:function(self,cnt_whole,cnt_page,page_num){var pagebar=$(self.elem.navi);pagebar.toggleClass("hide",cnt_whole<self.option.per_page);var last_page=Math.ceil(cnt_whole/self.option.per_page);0==last_page?page_num=0:0==page_num&&(page_num=1),function(self,pagebar,page_num,last_page){if(0==$("li",$(pagebar)).size()){$(pagebar).empty();var btnclass="",isNewFontAwesome=!0;$.each(document.styleSheets,function(i,n){if(n&&n.href&&-1!=n.href.indexOf("font-awesome-3.2.1"))return isNewFontAwesome=!1,!1});var iconFist="fa fa-step-backward",iconPrev="fa fa-backward",iconNext="fa fa-forward",iconLast="fa fa-step-forward";isNewFontAwesome||(iconFist="icon-step-backward",iconPrev="icon-backward",iconNext="icon-forward",iconLast="icon-step-forward"),1==page_num&&(btnclass=" disabled "),$(pagebar).append('<li class="csFirstPage'+btnclass+'" title="'+self.message.first_title+'" ><a href="javascript:void(0);"> <i class="'+iconFist+'"></i> </a></li>'),$(pagebar).append('<li class="csPreviousPage'+btnclass+'" title="'+self.message.prev_title+'" ><a href="javascript:void(0);"><i class="'+iconPrev+'"></i></a></li>');var pageInfo="第 "+page_num+" 页(共"+last_page+"页)";$(pagebar).append('<li class="disabled pageInfoBox"><a href="javascript:void(0);"> '+pageInfo+" </a></li>"),btnclass=page_num==last_page?" disabled ":"",$(pagebar).append('<li class="csNextPage'+btnclass+'" title="'+self.message.next_title+'" ><a href="javascript:void(0);"><i class="'+iconNext+'"></i></a></li>'),$(pagebar).append('<li class="csLastPage'+btnclass+'" title="'+self.message.last_title+'" ><a href="javascript:void(0);"> <i class="'+iconLast+'"></i> </a></li>')}}(self,pagebar,page_num,last_page);var pageInfoBox=$("li.pageInfoBox",$(pagebar)),pageInfo="第 "+page_num+" 页(共"+last_page+"页)";$(pageInfoBox).html('<a href="javascript:void(0);"> '+pageInfo+" </a>");var dClass="disabled",first=$("li.csFirstPage",$(pagebar)),previous=$("li.csPreviousPage",$(pagebar)),next=$("li.csNextPage",$(pagebar)),last=$("li.csLastPage",$(pagebar));1==page_num||0==page_num?($(first).hasClass(dClass)||$(first).addClass(dClass),$(previous).hasClass(dClass)||$(previous).addClass(dClass)):($(first).hasClass(dClass)&&$(first).removeClass(dClass),$(previous).hasClass(dClass)&&$(previous).removeClass(dClass)),page_num==last_page||0==last_page?($(next).hasClass(dClass)||$(next).addClass(dClass),$(last).hasClass(dClass)||$(last).addClass(dClass)):($(next).hasClass(dClass)&&$(next).removeClass(dClass),$(last).hasClass(dClass)&&$(last).removeClass(dClass)),last_page>1&&(self.prop.is_suggest?self.prop.max_suggest=last_page:self.prop.max_all=last_page,self._ehNaviPaging(self))},_displayResults:function(self,json,is_query){$(self.elem.results).empty();for(var arr_candidate=json.candidate,arr_primary_key=json.primary_key,keystr=$(self.elem.hidden).val(),keyArr=$.isArray(keystr)?keystr:keystr?keyArr=keystr.split(","):new Array,i=0;i<arr_candidate.length;i++){var itemText="";if(self.option.format_item&&$.isFunction(self.option.format_item))try{itemText=self.option.format_item(json.originalResult[i])}catch(e){console.error("formatItem内容格式化函数内容设置不正确！"),itemText=arr_candidate[i]}else itemText=arr_candidate[i];var list=$("<li>").html(itemText).attr({pkey:arr_primary_key[i],pvalue:arr_candidate[i],title:itemText});void 0!==arr_primary_key[i]&&-1!=$.inArray(arr_primary_key[i].toString(),keyArr)&&$(list).addClass(self.css_class.selected),$(list).data("dataObj",json.originalResult[i]),$(self.elem.results).append(list)}self._calcWidthResults(self),$(self.elem.container).addClass(self.css_class.container_open),self._ehResults(),is_query&&arr_candidate.length>0&&self.option.auto_select_first&&self._nextLine(self),$(self.elem.button).attr("title",self.message.close_btn)},_calcWidthResults:function(self){$(self.elem.result_area).show(1,function(){if("static"==$(self.elem.container).css("position")){offset=$(self.elem.combo_input).offset();$(self.elem.result_area).css({top:offset.top+$(self.elem.combo_input).outerHeight()+"px",left:offset.left+"px"})}else{var browserWidth=document.body.clientWidth,browserHeight=document.body.clientHeight,offset=$(self.elem.container).offset(),listWidth=$(self.elem.result_area).outerWidth(),listHeight=$(self.elem.result_area).outerHeight(),defaultLeft=self.option.multiple?-1:0,left=offset.left+listWidth>browserWidth?-(listWidth-$(self.elem.container).outerWidth()):defaultLeft,top=0;offset.top-$(window).scrollTop()+$(self.elem.container).outerHeight()+listHeight>browserHeight?(top=-(listHeight+1),$(self.elem.result_area).removeClass("shadowUp shadowDown").addClass("shadowUp")):(top=self.option.multiple?$(self.elem.container).innerHeight()+1:$(self.elem.container).outerHeight(),$(self.elem.result_area).removeClass("shadowUp shadowDown").addClass("shadowDown")),$(self.elem.result_area).css({top:top+"px",left:left+"px"})}})},_hideResults:function(self){self.prop.key_paging&&(self._scrollWindow(self,!0),self.prop.key_paging=!1),self._setCssFocusedInput(self),self.option.auto_fill_result,$(self.elem.results).empty(),$(self.elem.result_area).hide(),$(self.elem.container).removeClass(self.css_class.container_open),self._abortAjax(self),self._setButtonAttrDefault()},_firstPage:function(self){self.prop.page_all>1&&(self.prop.page_all=1,self.prop.is_paging=!0,self.prop.page_move=!0,self._suggest(self))},_prevPage:function(self){self.prop.page_all>1&&(self.prop.page_all--,self.prop.is_paging=!0,self.prop.page_move=!0,self._suggest(self))},_nextPage:function(self){self.prop.page_all<self.prop.max_all&&(self.prop.page_all++,self.prop.is_paging=!0,self.prop.page_move=!0,self._suggest(self))},_lastPage:function(self){self.prop.page_all<self.prop.max_all&&(self.prop.page_all=self.prop.max_all,self.prop.is_paging=!0,self.prop.page_move=!0,self._suggest(self))},_goPage:function(self,page){void 0===page&&(page=1),self.prop.page_all<self.prop.max_all&&(self.prop.page_all=page,self.prop.is_paging=!0,self.prop.page_move=!0,self._suggest(self))},_selectCurrentLine:function(self,is_enter_key){self._scrollWindow(self,!0);var current=self._getCurrentLine(self);if(current){var pkey=$(current).attr("pkey"),text=self.option.format_fill?$(current).text():$(current).attr("pvalue");if(self.option.multiple){$(self.elem.combo_input).val("");var item={text:text,value:pkey};self._isAlreadySelected(self,item)||(self._addNewTag(self,item),self._tagValuesSet(self))}else $(self.elem.combo_input).val(text),self._setHiddenValue(pkey);self.option.select_only&&self._setButtonAttrDefault(),$(self.elem.hidden).trigger("change"),"function"==typeof self.option.callback&&self.option.callback.call(self,$(current).data("dataObj")),self.option.bind_to&&$(self.elem.combo_input).trigger(self.option.bind_to,$(current).data("dataObj")),self.prop.prev_value=$(self.elem.combo_input).val(),self._hideResults(self)}$(self.elem.combo_input).trigger("change"),$(self.elem.combo_input).trigger("blur"),self._setCssFocusedInput(self),self._inputResize(self)},_getCurrentLine:function(self){if($(self.elem.result_area).is(":hidden"))return!1;var obj=$(self.elem.results).children("li."+self.css_class.select);return!!$(obj).length&&obj},_isAlreadySelected:function(self,item){var isExist=!1;if(item.value){var keys=$(self.elem.hidden).val();if(keys){var karr=$.isArray(keys)?keys:keys?keys.split(","):new Array;karr&&karr.length>0&&-1!=$.inArray(item.value,karr)&&(isExist=!0)}}return isExist},_addNewTag:function(self,item){if(self.option.multiple&&item){var tmp=self.template.tag.content;tmp=(tmp=tmp.replace(self.template.tag.textKey,item.text)).replace(self.template.tag.valueKey,item.value),$(self.elem.combo_input).closest("li").before($(tmp))}},_tagValuesSet:function(self){if(self.option.multiple){var tags=$("li.selected_tag",$(self.elem.element_box));if(tags&&$(tags).size()>0){var result=new Array;$.each(tags,function(i,li){var v=$(li).attr("itemvalue");"undefined"!=$.type(v)&&result.push(v)}),result.length>0&&self._setHiddenValue(result)}}},_inputResize:function(self){if(self.option.multiple){var inputLi=self.elem.combo_input.closest("li"),setDefaultSize=function(self,inputLi){inputLi.removeClass("full_width");var width=.75*(self.elem.combo_input.val().length+1)+"em";self.elem.combo_input.css("width",width),self.elem.combo_input.removeAttr("placeholder")};0==$("li.selected_tag",$(self.elem.element_box)).size()&&self.elem.combo_input.attr("placeholder_bak")?(inputLi.hasClass("full_width")||inputLi.addClass("full_width"),self.elem.combo_input.attr("placeholder",self.elem.combo_input.attr("placeholder_bak"))):setDefaultSize(self,inputLi)}},_nextLine:function(self){var idx,obj=self._getCurrentLine(self);if(obj?(idx=$(self.elem.results).children("li").index(obj),$(obj).removeClass(self.css_class.select)):idx=-1,++idx<$(self.elem.results).children("li").length){var next=$(self.elem.results).children("li").eq(idx);$(next).addClass(self.css_class.select),self._setCssFocusedResults(self)}else self._setCssFocusedInput(self);self._scrollWindow(self,!1)},_prevLine:function(self){var idx,obj=self._getCurrentLine(self);if(obj?(idx=$(self.elem.results).children("li").index(obj),$(obj).removeClass(self.css_class.select)):idx=$(self.elem.results).children("li").length,--idx>-1){var prev=$(self.elem.results).children("li").eq(idx);$(prev).addClass(self.css_class.select),self._setCssFocusedResults(self)}else self._setCssFocusedInput(self);self._scrollWindow(self,!1)}}),SelectPage});